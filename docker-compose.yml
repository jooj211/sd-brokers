version: '3.8'

networks:
  rabbitmq-net:
    driver: bridge
    name: rabbitmq-net
    ipam:
      config:
        - subnet: 172.20.0.0/16

services:
  rabbitmq1:
    build:
      context: ./rabbitmq
      dockerfile: Dockerfile
    container_name: rabbitmq1
    hostname: rabbitmq1
    restart: always
    cap_add:
      - NET_ADMIN
    environment:
      - RABBITMQ_NODENAME=rabbit@rabbitmq1
      - RABBITMQ_USE_LONGNAME=false
      - KEEPALIVED_PRIORITY=100
    ports:
      - "15672:15672"  # UI apenas no n√≥ principal
      - "1883:1883"
      - "5672:5672"
      - "4369:4369"
      - "25672:25672"
    volumes:
      - rabbitmq1_data:/var/lib/rabbitmq
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
    networks:
      rabbitmq-net: 
        ipv4_address: 172.20.0.2

  rabbitmq2:
    build:
      context: ./rabbitmq
      dockerfile: Dockerfile
    container_name: rabbitmq2
    hostname: rabbitmq2
    restart: always
    cap_add:
      - NET_ADMIN
    environment:
      - RABBITMQ_USE_LONGNAME=false
      - RABBITMQ_NODENAME=rabbit@rabbitmq2
      - KEEPALIVED_PRIORITY=90
    volumes:
      - rabbitmq2_data:/var/lib/rabbitmq
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf  # Monta o arquivo de config
    networks:
          rabbitmq-net: 
            ipv4_address: 172.20.0.3
    depends_on:
      - rabbitmq1

  rabbitmq3:
    build:
      context: ./rabbitmq
      dockerfile: Dockerfile
    container_name: rabbitmq3
    hostname: rabbitmq3
    restart: always
    cap_add:
      - NET_ADMIN
    environment:
      - RABBITMQ_USE_LONGNAME=false
      - RABBITMQ_NODENAME=rabbit@rabbitmq3
      - KEEPALIVED_PRIORITY=80
    volumes:
      - rabbitmq3_data:/var/lib/rabbitmq
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf  # Monta o arquivo de config
    networks:
          rabbitmq-net: 
            ipv4_address: 172.20.0.4
    depends_on:
      - rabbitmq1

  middleware:
    build: .
    container_name: middleware
    volumes:
      - ./middleware.py:/app/middleware.py
    environment:
      - RABBITMQ_HOST=172.20.0.100
    networks:
        rabbitmq-net: 
          ipv4_address: 172.20.0.5
    depends_on:
      - rabbitmq1
    command: ["python", "./middleware.py"]

  sensors:
    build: .
    container_name: sensors
    volumes:
      - ./sensors.py:/app/sensors.py
    environment:
      - RABBITMQ_HOST=172.20.0.100
    networks:
        rabbitmq-net: 
          ipv4_address: 172.20.0.6
    depends_on:
      - rabbitmq1
    command: ["python", "./sensors.py"]

  actuators:
    build: .
    container_name: actuators
    volumes:
      - ./actuators.py:/app/actuators.py
    environment:
      - RABBITMQ_HOST=172.20.0.100
    networks:
      rabbitmq-net: 
        ipv4_address: 172.20.0.7
    depends_on:
      - rabbitmq1
    command: ["python", "./actuators.py"]

volumes:
  rabbitmq1_data:
  rabbitmq2_data:
  rabbitmq3_data: